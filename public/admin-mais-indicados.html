<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Mais Indicados</title>

  <!-- Bootstrap opcional (só pra ficar minimamente alinhado com admin.html) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{padding:16px;max-width:960px;margin:0 auto;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#eef1f4;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
    .nav-admin a{margin-right:8px;font-size:.9rem;text-decoration:none;padding:4px 8px;border-radius:999px;}
    .nav-admin a.is-active{background:#0d6efd;color:#fff;}
    .nav-admin a:not(.is-active){color:#0d6efd;border:1px solid #0d6efd;}
    h1{font-size:1.4rem;margin:0;}
    textarea{width:100%;min-height:420px;font-family:monospace;font-size:.9rem;}
    button{padding:.5rem 1rem;margin-right:.5rem;cursor:pointer;}
    .status{font-size:.9rem;margin-top:.5rem;}
    .status.ok{color:green;}
    .status.err{color:#b00020;}
    .mini{font-size:.8rem;color:#6b7280;}
    label{font-weight:500;margin-bottom:.25rem;}
    .row-block{margin-bottom:1rem;}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Admin — Mais Indicados</h1>
      <div class="mini">Edita o arquivo <code>/assets/data/mais-indicados.json</code></div>
    </div>
    <nav class="nav-admin">
      <a href="/admin.html">Lineups</a>
      <a href="/admin-mais-indicados.html" class="is-active">Mais Indicados</a>
    </nav>
  </header>

  <div class="row-block">
    <button id="btn-load" type="button" class="btn btn-outline-secondary btn-sm">Carregar JSON atual</button>
    <button id="btn-save" type="button" class="btn btn-primary btn-sm">Salvar alterações</button>
  </div>

  <div class="row-block">
    <label for="json">mais-indicados.json</label>
    <textarea id="json" spellcheck="false"></textarea>
    <div id="status" class="status"></div>
  </div>

  <div class="row-block mini">
    Campos importantes:
    <ul>
      <li><code>comingSoon</code>: <strong>true</strong> = mostra aviso “levantamento em andamento”.</li>
      <li><code>hideWhenSoon</code>: <strong>true</strong> = some com campinho/banco enquanto estiver em levantamento.</li>
      <li><code>time</code> e <code>banco</code>: definem o time no campinho e o banco.</li>
    </ul>
  </div>

  <script>
    const txt = document.getElementById('json');
    const statusEl = document.getElementById('status');
    const btnLoad = document.getElementById('btn-load');
    const btnSave = document.getElementById('btn-save');

    function setStatus(msg, ok){
      statusEl.textContent = msg || '';
      statusEl.className = 'status ' + (ok ? 'ok' : 'err');
    }

    async function loadJson(){
      setStatus('Carregando...', true);
      try{
        const res = await fetch('/api/mais-indicados', { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        txt.value = JSON.stringify(data, null, 2);
        setStatus('JSON carregado.', true);
      }catch(e){
        console.error(e);
        setStatus('Erro ao carregar JSON: ' + e.message, false);
      }
    }

    async function saveJson(){
      setStatus('Salvando...', true);
      let obj;
      try{
        obj = JSON.parse(txt.value);
      }catch(e){
        setStatus('JSON inválido: ' + e.message, false);
        return;
      }

      try{
        const res = await fetch('/api/mais-indicados', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const body = await res.json();
        if(body.ok){
          setStatus('Salvo com sucesso em ' + (body.atualizado_em || ''), true);
        }else{
          setStatus('Erro ao salvar: ' + (body.error || 'desconhecido'), false);
        }
      }catch(e){
        console.error(e);
        setStatus('Erro ao salvar: ' + e.message, false);
      }
    }

    btnLoad.addEventListener('click', loadJson);
    btnSave.addEventListener('click', saveJson);

    // Carrega automaticamente ao abrir
    loadJson();
  </script>
</body>
</html>
