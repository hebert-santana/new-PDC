<!-- public/admin.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin — Lineups</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
:root{
  --pitch-w:631px; --pitch-h:892px;
  --active-w:575px; --active-h:813px; --off-x:28px; --off-y:40px;
  --ring:#0ea5b7; --img:92px; --img-coach:70px; --panel:#f7f7f8;
  --zoom:1;
}
*{box-sizing:border-box}
body{background:#eef1f4;color:#0f172a}
header{padding:12px 16px;background:#fff;border-bottom:1px solid #e5e7eb}

/* layout */
.wrap{max-width:1500px;margin:18px auto;padding:0 16px;display:grid;grid-template-columns:minmax(560px,1fr) minmax(520px,1.2fr);gap:16px}
@media (max-width:1100px){.wrap{grid-template-columns:1fr}}

.pitch{
  position:relative;width:var(--pitch-w);height:var(--pitch-h);
  background:url('/assets/img/campinhos/campinho.png') left top / var(--pitch-w) var(--pitch-h) no-repeat;
  border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.12); overflow:hidden;
  transform:scale(var(--zoom)); transform-origin:top left;
}
.pitch::after{content:""; position:absolute; left:var(--off-x); top:var(--off-y); width:var(--active-w); height:var(--active-h); outline:1px dashed rgba(14,165,183,.35); pointer-events:none}

/* BALÃO DO JOGADOR FIXO */
.player{
  position:absolute; transform:translate(-50%,-50%); text-align:center;
  width:var(--img); height:var(--img); overflow:visible;
}
.player img{
  display:block; width:var(--img); height:var(--img);
  border-radius:50%; background:#fff; border:2px solid #fff;
  box-shadow:0 4px 14px rgba(0,0,0,.28);
}
.player.coach{ width:var(--img-coach); height:var(--img-coach); }
.player.coach img{ width:var(--img-coach); height:var(--img-coach); margin:0 auto; }

/* legendas fora do balão para não deslocar a foto */
.player .cap{
  position:absolute; left:50%; top:100%; transform:translateX(-50%);
  margin-top:6px; font-size:.82rem; line-height:1.1; color:#0b192b;
  background:rgba(255,255,255,.96); border-radius:12px; padding:3px 8px;
  white-space:nowrap; max-width:160px; overflow:hidden; text-overflow:ellipsis;
}
.player .alt-cap{
  position:absolute; left:50%; top:calc(100% + 24px); transform:translateX(-50%);
  font-size:.74rem; line-height:1.1; color:#111;
  background:rgba(255,255,255,.96); border-radius:10px; padding:2px 7px;
  display:inline-block; white-space:nowrap;
}

.slot-chip{position:absolute;inset:auto auto 6px 6px;background:#111827;color:#fff;border-radius:8px;padding:2px 6px;font-size:.7rem;opacity:.9}
.dragging{outline:2px dashed var(--ring);outline-offset:4px;cursor:grabbing}

/* guias */
.guide{position:absolute;background:transparent;pointer-events:none}
.guide.x::after,.guide.y::after{content:"";position:absolute;background:var(--ring);opacity:.8}
.guide.x{height:0;width:100%}.guide.x::after{left:0;right:0;height:2px;top:-1px}
.guide.y{width:0;height:100%}.guide.y::after{top:0;bottom:0;width:2px;left:-1px}
.grid-dot{position:absolute;width:7px;height:7px;border-radius:50%;background:var(--ring);opacity:.35;pointer-events:none;box-shadow:0 0 0 2px rgba(14,165,183,.2)}

/* painel lateral */
.side{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(2,6,23,.06);max-height:calc(100vh - 120px);overflow:auto}
.cfg-row{display:grid;grid-template-columns:1.2fr .8fr .8fr auto;gap:8px}
.slot-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media (min-width:1400px){.slot-list{grid-template-columns:repeat(3,minmax(0,1fr))}}
.slot-card{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:var(--panel)}
.mini{font-size:.8rem}
.code{font-family:ui-monospace,Menlo,monospace;font-size:.84rem}

/* status */
.player.ok img{ box-shadow:0 0 0 3px #22c55e, 0 6px 14px rgba(0,0,0,.28) }
.player.doubt img{ box-shadow:0 0 0 3px #f59e0b, 0 6px 14px rgba(0,0,0,.28) }

</style>
</head>
<body>
<header class="d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center gap-3">
    <strong>Admin de Lineups</strong><span class="badge bg-info">Beta</span>
  </div>
  <div class="mini text-muted">Canvas 631×892 • área útil 575×813</div>
</header>

<div class="wrap">
  <!-- Campo -->
  <div>
    <div class="d-flex align-items-center gap-2 mb-2">
      <label class="mini text-muted">Zoom</label>
      <input id="zoom" type="range" min="0.6" max="1.2" step="0.02" value="1" class="form-range" style="width:200px">
    </div>
    <div class="pitch" id="pitch" aria-label="Editor">
      <div class="guide x" hidden></div><div class="guide y" hidden></div>
    </div>
    <div class="mt-2 mini text-muted">Imagens: <code>/assets/img/atletas</code> • IDs devem existir no mercado</div>
  </div>

  <!-- Painel -->
  <div>
    <div class="side">
      <div class="cfg-row align-items-center mb-2">
        <div>
          <label class="form-label">Time</label>
          <select id="teamSelect" class="form-select"></select>
        </div>
        <div>
          <label class="form-label">Formação</label>
          <select id="formacao" class="form-select">
            <option>4-3-3</option><option>4-4-2</option><option>3-5-2</option><option>4-2-3-1</option>
          </select>
        </div>
        <div>
          <label class="form-label">Alinhamento</label>
          <select id="alinhamento" class="form-select">
            <option value="rows" selected>Linhas</option>
            <option value="grid">Grade</option>
            <option value="free">Livre</option>
          </select>
        </div>
        <div class="d-flex gap-1 align-self-end">
          <button id="btnLoad" class="btn btn-outline-secondary btn-sm">Carregar</button>
          <button id="btnSave" class="btn btn-primary btn-sm">Salvar</button>
          <button id="btnApply" class="btn btn-success btn-sm">Atualizar formação</button>
        </div>
      </div>

      <div class="d-flex align-items-center mb-2">
        <div class="form-check me-3">
          <input class="form-check-input" type="checkbox" id="snapPeers" checked>
          <label class="form-check-label" for="snapPeers">Alinhar a colegas</label>
        </div>
        <div class="form-check me-3">
          <input class="form-check-input" type="checkbox" id="showGuides">
          <label class="form-check-label" for="showGuides">Mostrar guias</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="onlyClub" checked>
          <label class="form-check-label" for="onlyClub">Só do clube</label>
        </div>
      </div>

      <div class="mb-2">
        <label class="form-label">Buscar atleta por nome ou ID</label>
        <input id="q" class="form-control" placeholder="Ex.: Hulk, Scarpa, 39148"/>
        <div id="qList" class="mt-2" style="max-height:260px;overflow:auto"></div>
      </div>

      <div class="slot-list" id="slotList"></div>
      <hr/>
      <div class="d-flex gap-2 flex-wrap align-items-center">
        <button id="btnExport" class="btn btn-outline-secondary btn-sm">Exportar JSON</button>
        <label class="btn btn-outline-secondary btn-sm mb-0">Importar JSON
          <input id="fileImport" type="file" accept="application/json" hidden>
        </label>
        <button id="btnClear" class="btn btn-outline-danger btn-sm">Limpar time</button>
        <button id="btnClearCache" class="btn btn-outline-warning btn-sm">Limpar cache local</button>
        <span class="mini text-muted ms-auto">Endpoint: <span class="code">POST /api/lineups</span></span>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{'use strict';

/* util */
const fold=s=>(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\p{L}\p{N}\s.]/gu,'');
const PITCH_W=631,PITCH_H=892,ACTIVE_W=575,ACTIVE_H=813,OFF_X=28,OFF_Y=40;
const TOL=8,GRID_X=[20,30,35,40,50,60,65,70,80],GRID_Y=[90,78,75,65,60,58,55,40,35,30,25];
const CANON=['GOL','ZAG-L','ZAG-C','ZAG-R','LAT-L','LAT-R','VOL','MEI-L','MEI-C','MEI-R','ATA-L','ATA-C','ATA-R','TEC'];
const PRESETS={
 '4-3-3':{'GOL':[50,90],'ZAG-L':[35,75],'ZAG-C':[50,75],'ZAG-R':[65,75],'LAT-L':[15,72],'LAT-R':[85,72],'MEI-L':[25,55],'MEI-C':[50,35],'MEI-R':[75,55],'ATA-L':[20,20],'ATA-R':[80,20],'ATA-C':[50,10],'TEC':[10,93]},
 '4-4-2':{'GOL':[50,90],'ZAG-L':[35,75],'ZAG-C':[50,75],'ZAG-R':[65,75],'LAT-L':[15,72],'LAT-R':[85,72],'VOL':[50,60],'MEI-L':[25,45],'MEI-C':[50,35],'MEI-R':[75,45],'ATA-L':[35,15],'ATA-R':[65,15],'TEC':[10,93]},
 '3-5-2':{'GOL':[50,90],'ZAG-L':[25,75],'ZAG-C':[50,72],'ZAG-R':[75,75], 'LAT-L':[15,45],'LAT-R':[85,45],'VOL':[50,55],'MEI-L':[35,55],'MEI-C':[50,35],'MEI-R':[65,55],'ATA-L':[35,15],'ATA-R':[65,15],'TEC':[10,93]},
 '4-2-3-1':{'GOL':[50,90],'ZAG-L':[40,75],'ZAG-R':[60,75],'LAT-L':[22,78],'LAT-R':[78,78],'VOL':[40,64],'VOL2':[60,64],'MEI-L':[35,55],'MEI-C':[50,52],'MEI-R':[65,55],'ATA-C':[50,30],'TEC':[10,93]}
};

const state={teamKey:null,formacao:'4-3-3',lineup:[],tecnico:null,alin:'rows',mercado:null,lineupsJson:null};
const $=id=>document.getElementById(id),qs=(s,r=document)=>r.querySelector(s),qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
const pct=v=>`${v}%`,clamp=(v,a,b)=>Math.max(a,Math.min(b,v)),px2pctX=px=>(px/PITCH_W)*100,px2pctY=px=>(px/PITCH_H)*100,pct2pxX=p=>(p/100)*PITCH_W,pct2pxY=p=>(p/100)*PITCH_H;

/* dados */
const foto=id=>{
  const a=state.mercado?.byId?.get(+id);
  const cid=a?.clube_id??0;
  const f=(a?.foto||'').trim();
  return f || `/assets/img/escudos/cartola/${cid}.jpg`;
};
const nome=id=>{
  const a=state.mercado?.byId?.get(+id);
  return a?.apelido_abreviado||a?.apelido||a?.nome||String(id);
};

async function loadMercado(){
  const urls = ['/assets/data/mercado.images.json','/data/mercado.images.json'];
  for (const u of urls){
    try{
      const r = await fetch(u, { cache:'no-store' });
      if (!r.ok) continue;
      const arr = await r.json();
      window.MERCADO = arr;
      state.mercado = {
        byId: new Map(arr.map(a => [a.atleta_id, a])),
        byClub: arr.reduce((m,a)=>{ (m[a.clube_id]??=[]).push(a); return m; },{})
      };
      for (const k in state.mercado.byClub){
        state.mercado.byClub[k].sort((a,b)=>(a.apelido_abreviado||a.apelido||a.nome||'')
          .localeCompare(b.apelido_abreviado||b.apelido||b.nome||'','pt-BR'));
      }
      return;
    }catch{}
  }
}

async function loadJogos(){
  return new Promise(res=>{
    const s=document.createElement('script');
    s.src='/assets/js/jogos.data.js?_='+Date.now();
    s.onload=s.onerror=()=>res();
    document.head.appendChild(s);
  });
}

function buildTeamSelect(){
  const sel=$('teamSelect'); sel.innerHTML='';
  const teams=new Map();
  (window.JOGOS||[]).forEach(j=>{
    if(j.home)teams.set(j.home.key,j.home.name);
    if(j.away)teams.set(j.away.key,j.away.name);
  });
  [...teams.entries()].sort((a,b)=>a[1].localeCompare(b[1],'pt-BR')).forEach(([k,n])=>{
    const o=document.createElement('option'); o.value=k; o.textContent=n; sel.appendChild(o);
  });
}

function currentClubId(){
  const k = state.teamKey;
  for (const j of (window.JOGOS||[])){
    if (j.home?.key===k) return j.home.clube_id || window.TEAMKEY_TO_CLUBEID?.[k] || null;
    if (j.away?.key===k) return j.away.clube_id || window.TEAMKEY_TO_CLUBEID?.[k] || null;
  }
  return window.TEAMKEY_TO_CLUBEID?.[k] || null;
}

function clubRoster(){
  const cid = currentClubId();
  const all = Array.from(state.mercado?.byId?.values() || []);
  return (cid && state.mercado?.byClub?.[cid]) ? state.mercado.byClub[cid] : all;
}

/* lineups.json merge local + servidor */
async function getMergedLineups(){
  let base={version:1,tz:'-03:00',teams:{}};
  try{
    const r=await fetch('/assets/data/lineups.json',{cache:'no-store'});
    if(r.ok) base=await r.json();
  }catch{}
  const ov=JSON.parse(localStorage.getItem('lineups_override')||'{"teams":{}}');
  base.teams=Object.assign({},base.teams||{},ov.teams||{});
  return base;
}
function saveOverrideLocal(payload){
  const prev=JSON.parse(localStorage.getItem('lineups_override')||'{"version":1,"tz":"-03:00","teams":{}}');
  prev.teams=Object.assign(prev.teams||{},payload.teams||{});
  localStorage.setItem('lineups_override',JSON.stringify(prev));
}
function mergeIntoState(payload){
  state.lineupsJson??={version:1,tz:'-03:00',teams:{}};
  state.lineupsJson.teams=Object.assign({},state.lineupsJson.teams||{},payload.teams||{});
}

/* busca global */
function searchRows(query,onlyClub){
  const s=fold(query||'');
  const pool=onlyClub?clubRoster():Array.from(state.mercado?.byId?.values()||[]);
  if(!s) return onlyClub?pool.map(a=>({id:a.atleta_id,nome:a.apelido_abreviado||a.apelido||a.nome})):[];
  const rows=[];
  for(const a of pool){
    const t=fold(`${a.apelido_abreviado||a.apelido||a.nome||''} ${a.atleta_id}`);
    if(t.includes(s)) rows.push({id:a.atleta_id,nome:a.apelido_abreviado||a.apelido||a.nome});
    if(rows.length>=60) break;
  }
  return rows;
}
function wireSearch(){
  const q=$('q'),list=$('qList');
  const render=(rows,targetSlot=null)=>{
    list.innerHTML='';
    rows.forEach(r=>{
      const btn=document.createElement('button');
      btn.className='btn btn-sm btn-light w-100 text-start mb-1';
      btn.textContent=`${r.nome} — ${r.id}`;
      btn.onclick=()=>{
        const slot=targetSlot||(CANON.find(s=>!state.lineup.some(p=>p.slot===s))||'MEI-C');
        upsertPlayer(slot,r.id); buildSlotList(); renderPitch();
      };
      list.appendChild(btn);
    });
  };
  const run=()=>render(searchRows(q.value,$('onlyClub').checked));
  q.oninput=run; $('onlyClub').onchange=run; render(searchRows('',true));
}

/* selects de atleta e de "dúvida com" */
function buildSelectOptions(sel, value){
  sel.innerHTML='';
  const opt0=document.createElement('option');opt0.value='';opt0.textContent='— selecionar —';
  sel.appendChild(opt0);
  for(const a of clubRoster()){
    const o=document.createElement('option');
    o.value=String(a.atleta_id);
    o.textContent=`${a.apelido_abreviado||a.apelido||a.nome} — ${a.atleta_id}`;
    sel.appendChild(o);
  }
  if(value) sel.value=String(value);
}

/* painel de slots */
function buildSlotList(){
  const box=$('slotList'); box.innerHTML='';
  const slots=Array.from(new Set([...CANON, ...Object.keys(PRESETS[state.formacao]||{})]));
  for(const slot of slots){
    const p=state.lineup.find(x=>x.slot===slot);
    const sitVal=p?.sit ?? 'provavel';
    const row=document.createElement('div'); row.className='slot-card';
    const wrap=document.createElement('div'); wrap.className='d-flex flex-wrap align-items-center gap-2';
    wrap.innerHTML=`
      <div class="fw-semibold" style="min-width:60px">${slot}</div>
      <select class="form-select form-select-sm" style="width:240px" data-slot-sel="${slot}"></select>
      <select class="form-select form-select-sm" style="width:110px" data-sit="${slot}">
        <option value="provavel"${sitVal==='provavel'?' selected':''}>Provável</option>
        <option value="duvida"${sitVal==='duvida'?' selected':''}>Dúvida</option>
        <option value="normal"${sitVal==='normal'?' selected':''}>Normal</option>
      </select>
      <select class="form-select form-select-sm" style="width:260px;${sitVal==='duvida'?'':'display:none'}" data-duvsel="${slot}"></select>
      <button class="btn btn-sm btn-outline-secondary" data-act="focus" data-slot="${slot}">Focar</button>
      <button class="btn btn-sm btn-outline-danger" data-act="clear" data-slot="${slot}">Limpar</button>
    `;
    row.appendChild(wrap); box.appendChild(row);

    const sel=qs(`select[data-slot-sel="${slot}"]`,row);
    buildSelectOptions(sel,p?.id||'');
    sel.onchange=()=>{
      const val=Number(sel.value||0); if(!val) return;
      upsertPlayer(slot,val); renderPitch();
      const duvSel=qs(`select[data-duvsel="${slot}"]`,row);
      if(duvSel) buildSelectOptions(duvSel, state.lineup.find(x=>x.slot===slot)?.duvida_com || '');
    };

    const duvSel=qs(`select[data-duvsel="${slot}"]`,row);
    const wireDuvSel=()=>{
      const cur=state.lineup.find(x=>x.slot===slot);
      duvSel.style.display=(cur?.sit==='duvida')?'':'none';
      if(cur?.sit==='duvida') buildSelectOptions(duvSel, cur?.duvida_com || '');
    };
    wireDuvSel();
    duvSel.onchange=()=>{
      const pl=state.lineup.find(x=>x.slot===slot); if(!pl) return;
      pl.duvida_com=Number(duvSel.value||0)||undefined; renderPitch();
    };
  }

  box.onchange=(e)=>{
    const sel=e.target.closest('select[data-sit]'); if(!sel) return;
    const p=state.lineup.find(x=>x.slot===sel.dataset.sit); if(!p) return;
    p.sit=sel.value;
    const duvSel=qs(`select[data-duvsel="${sel.dataset.sit}"]`,box);
    if(duvSel){
      duvSel.style.display=(p.sit==='duvida')?'':'none';
      if(p.sit==='duvida') buildSelectOptions(duvSel, p.duvida_com || '');
      else p.duvida_com=undefined;
    }
    renderPitch();
  };

  box.onclick=(e)=>{
    const btn=e.target.closest('button[data-act]'); if(!btn) return;
    const slot=btn.dataset.slot;
    if(btn.dataset.act==='clear'){ removePlayer(slot); buildSlotList(); renderPitch(); }
    if(btn.dataset.act==='focus'){ focusSlot(slot); }
  };
}

/* helpers lineup */
function focusSlot(slot){
  const el=qs(`.player[data-slot="${slot}"]`,$('pitch')); if(!el) return;
  el.scrollIntoView({behavior:'smooth',block:'center'});
  el.animate([{transform:'translate(-50%,-50%) scale(1)'},{transform:'translate(-50%,-50%) scale(1.06)'}],{duration:220,direction:'alternate',iterations:2});
}
function applyPreset(){
  const P=PRESETS[state.formacao]||{};
  state.lineup=state.lineup.map(p=>P[p.slot]?{...p,x:P[p.slot][0],y:P[p.slot][1]}:p);
}
function upsertPlayer(slot,id){
  const ex=state.lineup.find(p=>p.slot===slot);
  if(ex){ ex.id=id; }
  else{
    const d=(PRESETS[state.formacao]||{})[slot]||[50,55];
    state.lineup.push({slot,id,x:d[0],y:d[1],sit:'provavel'});
  }
}
function removePlayer(slot){ state.lineup=state.lineup.filter(p=>p.slot!==slot); }

/* render */
function renderPitch(){
  const pitch=$('pitch'); pitch.querySelectorAll('.player').forEach(n=>n.remove());
  for(const p of state.lineup){
    const fig=document.createElement('figure');
    fig.className=`player ${p.sit==='duvida'?'doubt':'ok'}`; if(p.slot==='TEC') fig.classList.add('coach');
    fig.dataset.slot=p.slot; fig.dataset.id=p.id; fig.style.left=pct(p.x); fig.style.top=pct(p.y);
    const img=new Image(); img.loading='lazy'; img.decoding='async'; img.width=92; img.height=92; img.alt=nome(p.id); img.src=foto(p.id);
    img.onerror=()=>{const cid=state.mercado?.byId?.get(+p.id)?.clube_id??0; img.onerror=null; img.src=`/assets/img/escudos/cartola/${cid}.jpg`;};
    const nm=document.createElement('figcaption'); nm.className='cap'; nm.textContent=nome(p.id);
    fig.appendChild(img); fig.appendChild(nm);
    if(p.sit==='duvida' && p.duvida_com){const alt=document.createElement('div'); alt.className='alt-cap'; alt.textContent=nome(p.duvida_com); fig.appendChild(alt);}
    const chip=document.createElement('span'); chip.className='slot-chip'; chip.textContent=p.slot; fig.appendChild(chip);
    enableDrag(fig,p); pitch.appendChild(fig);
  }
  toggleGuides();
  qsa('select[data-slot-sel]').forEach(sel=>{const slot=sel.getAttribute('data-slot-sel');const p=state.lineup.find(x=>x.slot===slot);buildSelectOptions(sel,p?.id||'');});
  qsa('select[data-duvsel]').forEach(sel=>{const slot=sel.getAttribute('data-duvsel');const p=state.lineup.find(x=>x.slot===slot);buildSelectOptions(sel,p?.duvida_com||''); sel.style.display=(p?.sit==='duvida')?'':'none';});
}

/* drag + guias */
function enableDrag(el,model){
  let sx=0,sy=0,ox=0,oy=0; const gx=qs('.guide.x',$('pitch')),gy=qs('.guide.y',$('pitch'));
  function onDown(ev){const p=point(ev);sx=p.x;sy=p.y;ox=pct2pxX(model.x);oy=pct2pxY(model.y);el.classList.add('dragging');window.addEventListener('pointermove',onMove);window.addEventListener('pointerup',onUp,{once:true});el.setPointerCapture(ev.pointerId);}
  function onMove(ev){
    const p=point(ev);let nx=clamp(ox+(p.x-sx),0,PITCH_W);let ny=clamp(oy+(p.y-sy),0,PITCH_H);
    if(state.alin!=='free'){
      const sx1=snapList(nx,GRID_X.map(pct2pxX),TOL);
      const sy1=snapList(ny,GRID_Y.map(pct2pxY),TOL);
      if((state.alin==='grid'||state.alin==='rows')&&sx1.snapped)nx=sx1.value;
      if(state.alin==='rows'&&sy1.snapped)ny=sy1.value;
    }
    if($('snapPeers').checked){
      const peers=state.lineup.filter(pp=>pp!==model);
      const xs=peers.map(pp=>pct2pxX(pp.x)); const ys=peers.map(pp=>pct2pxY(pp.y));
      const sx2=snapList(nx,xs,TOL),sy2=snapList(ny,ys,TOL);
      if(sx2.snapped)nx=sx2.value; if(sy2.snapped)ny=sy2.value;
    }
    el.style.left=pct(px2pctX(nx)); el.style.top=pct(px2pctY(ny));
    if($('showGuides').checked){gx.style.visibility='visible'; gy.style.visibility='visible'; gx.style.top=`${ny}px`; gy.style.left=`${nx}px`;}
  }
  function onUp(){const left=parseFloat(el.style.left),top=parseFloat(el.style.top);model.x=clamp(left,0,100);model.y=clamp(top,0,100);el.classList.remove('dragging');showGuides(false);window.removeEventListener('pointermove',onMove);}
  el.addEventListener('pointerdown',onDown);
}
function point(ev){
  const r=$('pitch').getBoundingClientRect();
  let x=ev.clientX-r.left,y=ev.clientY-r.top;
  x=clamp(x,OFF_X,OFF_X+ACTIVE_W); y=clamp(y,OFF_Y,OFF_Y+ACTIVE_H);
  return{x,y};
}
function snapList(v,list,tol){let best={dist:Infinity,value:v,snapped:false};for(const t of list){const d=Math.abs(v-t);if(d<best.dist)best={dist:d,value:t,snapped:d<=tol};}return best;}

function toggleGuides(){
  const on=$('showGuides').checked,p=$('pitch');
  qsa('.guide,.grid-dot',p).forEach(n=>n.remove()); if(!on) return;
  GRID_X.forEach(px=>GRID_Y.forEach(py=>{
    const d=document.createElement('div'); d.className='grid-dot'; d.style.left=`${pct2pxX(px)}px`; d.style.top=`${pct2pxY(py)}px`; p.appendChild(d);
  }));
  const gx=document.createElement('div'); gx.className='guide x';
  const gy=document.createElement('div'); gy.className='guide y';
  p.appendChild(gx); p.appendChild(gy);
}
function showGuides(active){
  const on=$('showGuides').checked;
  qsa('.guide',$('pitch')).forEach(g=>g.style.visibility=(on&&active)?'visible':'hidden');
}

/* persistência */
function currentPayload(){
  const k=state.teamKey, out={version:1,tz:'-03:00',teams:{}};
  out.teams[k]={
    formacao:state.formacao,
    titulares:state.lineup.map(p=>({slot:p.slot,id:p.id,x:+p.x,y:+p.y,sit:p.sit||'provavel',duvida_com:p.duvida_com||undefined})),
    tecnico:state.tecnico||undefined
  };
  return out;
}
const CH=new BroadcastChannel('lineups');
function notifyClients(){try{CH.postMessage({type:'refresh',teamKey:state.teamKey,ts:Date.now()});}catch{}}

/* botões */
$('btnApply').onclick=()=>{
  const payload=currentPayload();
  saveOverrideLocal(payload); mergeIntoState(payload); notifyClients();
  alert('Formação aplicada localmente.');
};
$('btnSave').onclick = async () => {
  const k = state.teamKey;
  const payload = currentPayload(); // { version, tz, teams:{ [k]: {...} } }

  try {
    const r = await fetch('/api/lineups',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ merge:true, teams: payload.teams })
    });
    
    if (!r.ok) throw new Error('HTTP ' + r.status);
    alert('Salvo no servidor (lineups.json atualizado).');
  } catch (e) {
    // fallback: download do JSON do time
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `lineup-${k}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    alert('Servidor indisponível. Baixei o JSON do time.');
  } finally {
    saveOverrideLocal(payload);
    mergeIntoState(payload);
  }
};

$('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(currentPayload(),null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`lineup-${state.teamKey}.json`; a.click(); URL.revokeObjectURL(a.href);
};
$('fileImport').onchange=async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  state.lineupsJson=JSON.parse(await f.text()); loadTeam();
};
$('btnClear').onclick=()=>{ if(confirm('Limpar escalação deste time?')){ state.lineup=[]; buildSlotList(); renderPitch(); } };
$('btnClearCache').onclick=()=>{ localStorage.removeItem('lineups_override'); alert('Cache local apagado.'); };
$('zoom').oninput=e=>{ document.documentElement.style.setProperty('--zoom',e.target.value); };

/* ciclo de carga */
async function loadTeam(){
  const team=state.lineupsJson?.teams?.[state.teamKey]||null;
  if(team){
    state.formacao=team.formacao||'4-3-3'; $('formacao').value=state.formacao;
    state.lineup=Array.isArray(team.titulares)
      ? team.titulares.map(p=>({slot:p.slot,id:+p.id,x:+p.x||50,y:+p.y||55,sit:p.sit||'provavel',duvida_com:p.duvida_com||undefined}))
      : [];
    state.tecnico=Number.isFinite(team.tecnico)?team.tecnico:null;
    if(Number.isFinite(state.tecnico)&&!state.lineup.some(p=>p.slot==='TEC')){
      const d=(PRESETS[state.formacao]||{}).TEC||[92,96];
      state.lineup.push({slot:'TEC',id:state.tecnico,x:d[0],y:d[1],sit:'normal'});
    }
  }else{
    state.lineup=[]; state.tecnico=null;
  }
  buildSlotList(); renderPitch(); wireSearch();
}
$('formacao').onchange=()=>{ state.formacao=$('formacao').value; applyPreset(); buildSlotList(); renderPitch(); };
$('alinhamento').onchange=()=>{ state.alin=$('alinhamento').value; };
$('showGuides').onchange=toggleGuides;
$('btnLoad').onclick=loadTeam;
$('teamSelect').onchange=()=>{ state.teamKey=$('teamSelect').value; loadTeam(); };

(async function boot(){
  await loadMercado();
  await loadJogos();
  state.lineupsJson=await getMergedLineups();
  buildTeamSelect();
  state.teamKey=$('teamSelect').value;
  wireSearch();
  await loadTeam();
})();
})();
</script>
</body>
</html>
